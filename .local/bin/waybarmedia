#!/bin/bash

# https://gitlab.com/xPMo/dotfiles.cli/-/blob/dots/.local/lib/waybar/playerctl.sh
exec 2>"$XDG_RUNTIME_DIR/waybar-playerctl.log"
IFS=$'\n\t'

while true; do
    while read -r status position length artist album title hpos hlen; do
        # remove leaders
        status=${status:1}
        position=${position:1}
        length=${length:1}
		artist=${artist:1}
        album=${album:1}
        title=${title:1}
        hpos=${hpos:1}
        hlen=${hlen:1}

		# build line
		# line="${artist:+$artist ${title:+- }}${title:+$title }${hpos:+$hpos${hlen:+|}}$hlen"
		line=" ${title:+$title ${artist:+- }}${artist:+$artist}"
		tooltip="${title:+$title ${album:+- }}${album:+$album }${artist:+- }${artist:+$artist }${hpos:+$hpos${hlen:+ / }}$hlen"

		# json escaping
		line="${line//\"/\\\"}"
		((percentage = length ? (100 * (position % length)) / length : 0))
		case $status in
		    Paused) text="$line" ;;
		    Playing) text="$line" ;;
		    *) text="" ;;
		esac

		# exit if print fails
		printf '{"text":"%s","tooltip":"%s","class":["%s","%s"],"percentage":%s}\n' "$text" "$tooltip" "$status" "$percentage" "$percentage" || break 2

	done < <(
		# requires playerctl>=2.0
		# Add non-space character ":" before each parameter to prevent 'read' from skipping over them
		playerctl --follow metadata --player=mpd --format \
            $':{{status}}\t:{{position}}\t:{{mpris:length}}\t:{{markup_escape(artist)}}\t:{{markup_escape(album)}}\t:{{markup_escape(title)}}\t:{{duration(position)}}\t:{{duration(mpris:length)}}' &
		echo $! >"$XDG_RUNTIME_DIR/waybar-playerctl.pid"
	)

	# no current players
	# exit if print fails
	echo '<span foreground=#dc322f>⏹</span>' || break
	sleep 15

done

kill "$(<"$XDG_RUNTIME_DIR/waybar-playerctl.pid")"

